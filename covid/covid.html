<html>
  <head>
<!-- Acknowledgments to: COVID Tracking Project and Google Charts
-->
<title>COVID-19 Death and Testing Stats, by U.S. State</title>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135665174-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-135665174-1');
</script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<meta property="og:url"         content="http://wwpages.github.io/covid/covid.html" />
<meta property="og:site_name"   content="Stats from COVID Trackind Project" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="COVID-19 Death and Testing Stats, by U.S. State" />
<meta property="og:description" content="Day-by-day and cumulative charts" />
<meta property="og:image"       content="http://wwpages.github.io/covid/covid.png" />
<meta property="og:image:width"  content="1200" />
<meta property="og:image:height" content="630" />

    <!--Load Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">

// Load the Visualization API and the corechart package.
google.charts.load('current', {'packages':['corechart']});

// Set a callback to run when the Google Visualization API is loaded.
google.charts.setOnLoadCallback(getAndDraw);

// Globals, set by getAndDraw() and used by drawAll()
var state, StateName, days, stateData;
var regionDefaulted = false;
var CHARTS = [
    ['deaths',  'COVID-19 Deaths, Each Day', 'deathIncrease', 'Deaths', true],
    ['results', 'COVID-19 Test Results, Each Day', 'totalTestResultsIncrease', 'Test Results', true],
    ['positives', 'Positive COVID-19 Test Results, Each Day', 'positiveIncrease', 'Positive Test Results', true],
    ['negatives', 'Negative COVID-19 Test Results, Each Day', 'negativeIncrease', 'Negative Test Results', true],
    // ['hospitalized', 'New COVID-19 Hospitalizations, Each Day', 'hospitalizedIncrease', 'Patients'],
    ['cumdeath',  'Cumulative COVID-19 Deaths', 'death', 'Deaths', false],
    ['cumresults',  'Cumulative COVID-19 Test Results', 'totalTestResults', 'Test Results', false],
    ['cumpositives', 'Cumulative Positive COVID-19 Test Results', 'positive', 'Positive Test Results', false],
    ['cumnegatives', 'Cumulative Negative COVID-19 Test Results', 'negative', 'Negative Test Results', false]
    // ['cumhospitalized', 'Cumulative COVID-19 Hospitalizations', 'hospitalized', 'Patients', false]
];

function getAndDraw() {

    var stateList = document.getElementById('state')

    // Default selected region from URL if given
    if ( ! regionDefaulted ) {
        var url = window.location.href;
        var idx = url.lastIndexOf('#');
        if ( idx >= 0 ) {
            state = url.substring(idx+1);
            var opts = stateList.options;
            for (var si=0; si < opts.length; si++ ) {
                if ( opts[si].value == state ) {
                    stateList.selectedIndex = si;
                    regionDefaulted = true;
                    break;
                }
            }
        }
    }
    
    var stateOpt = stateList.options[stateList.selectedIndex];
    state = stateOpt.value;
    stateName = stateOpt.text;

    var daysList = document.getElementById('days')
    var daysOpt = daysList.options[daysList.selectedIndex];
    days = parseInt(daysOpt.value);

    // COVID Tracking has separate API for US vs. states
    var dataUrl = 'https://covidtracking.com/api/v1/';
    if ( state == "US" )
        dataUrl += 'us/daily.json';
    else
        dataUrl += 'states/' + state.toLowerCase() + '/daily.json';

    // fetch(dataUrl, {mode: 'no-cors'})
    fetch(dataUrl)
        .then(
            function(response) {
                if (response.status !== 200) {
                    console.log('Looks like there was a problem. Status Code: ' + response.status);
                    return;
                }
                
                // Save away the response data for redraw
                response.json().then(function(data) {
                    stateData = data;
                    drawAll();
                });
            }
        )
        .catch(function(err) {
            console.log('Fetch Error :-S', err);
        });
}

function drawAll() {
    for (var i=0; i < CHARTS.length; i++) {
        var [chartid, title, metric, unit, show_average] = CHARTS[i];
        title += ' â€” ' + stateName;
        drawChart(metric, unit, chartid, title, show_average);
    }
}

function yyyymmdd_to_date(d) {
    var s = d.toString();
    var year = parseInt(s.substring(0, 4));
    var month = parseInt(s.substring(4, 6)) - 1;
    var day = parseInt(s.substring(6, 8));
    return new Date(year, month, day);
}

// Draw a single chart for a particular metric
function drawChart(metric, unit, chartid, title, show_average) {

    // Get the raw data and moving average
    var pairs = []
    var lim = stateData.length >= days ? days : stateData.length;
    for (var i = 0; i < stateData.length; i++) {
        var dt = yyyymmdd_to_date(stateData[i].date);
        var value = stateData[i][metric];
        pairs.push([dt, value]);
    }
    pairs = pairs.reverse();

    var AVG_DAYS = 7;
    var raw = []
    var window_start = -1;
    var avg_start = -1;
    var window_sum = 0;
    for (var i = 0; i < pairs.length; i++) {
        var [dtstr, value] = pairs[i];
        var avg_value = undefined;
        if ( ! show_average ) {
            raw.push([dtstr, value, avg_value]);
            continue;
        }
        if ( value && window_start < 0 ) {
            window_start = i;
            avg_start = window_start + AVG_DAYS - 1;
        }
        if ( window_start >= 0 ) {
            var a_value = value;
            if ( ! value )
                a_value = 0;
            window_sum += a_value;
            if ( i >= avg_start ) {
                if ( i > avg_start ) {
                    var sub_value = pairs[i - AVG_DAYS][1];
                    if ( ! sub_value )
                        sub_value = 0;
                    window_sum -= sub_value;
                }
                avg_value = window_sum / AVG_DAYS;
            }
        }
        raw.push([dtstr, value, avg_value]);
    }

    // Create the data table.
    data = new google.visualization.DataTable();
    data.addColumn('date', 'Date');
    data.addColumn('number', unit);
    if ( show_average )
        data.addColumn('number', AVG_DAYS.toString() + '-day Average');
    var rows = [];
    var any_data = false;
    for (var i = raw.length - lim; i < raw.length; i++) {
        var dtstr = raw[i][0];
        var value = raw[i][1];
        if ( value )
            any_data = true;
        if ( show_average )
            rows.push([dtstr, value, raw[i][2]]);
        else
            rows.push([dtstr, value]);
    }
    data.addRows(rows);
    
    // Hide if no data
    var divElt = document.getElementById(chartid + '_div');
    if ( ! any_data )
        divElt.style.display = 'none';
    else {
        divElt.style.display = 'inherit';
        
        // Set chart options
        var options = {
            title: title,
            vAxis: { title: unit, minValue: 0},
            hAxis: { format: 'MMM\nd', gridlines: { color: 'transparent' } }
        };

        // Instantiate and draw chart
        var chart;
        if ( show_average ) {
            options.lineWidth = 3;
            options.seriesType = 'bars';
            options.series = {1: {type: 'line'}};
            chart = new google.visualization.ComboChart(divElt);
        }
        else
            chart = new google.visualization.ColumnChart(divElt);
        chart.draw(data, options);
    }
}

    </script>
  </head>

  <body>

    <style>
    .cchart { width: 100%;
              margin: 0 0 20px 0;
            }
    .nopad { width: 100%;
           }
    </style>

Data source: COVID Tracking Project (<a href="https://covidtracking.com/">covidtracking.com</a>)

<br/>

Region:
<select id="state" onchange="getAndDraw()">
<option value="US">United States</option>
<option value="AL">Alabama</option>
<option value="AK">Alaska</option>
<option value="AS">American Samoa</option>
<option value="AZ">Arizona</option>
<option value="AR">Arkansas</option>
<option value="CA">California</option>
<option value="CO">Colorado</option>
<option value="CT">Connecticut</option>
<option value="DE">Delaware</option>
<option value="DC">District Of Columbia</option>
<option value="FL">Florida</option>
<option value="GA">Georgia</option>
<option value="GU">Guam</option>
<option value="HI">Hawaii</option>
<option value="ID">Idaho</option>
<option value="IL">Illinois</option>
<option value="IN">Indiana</option>
<option value="IA">Iowa</option>
<option value="KS">Kansas</option>
<option value="KY">Kentucky</option>
<option value="LA">Louisiana</option>
<option value="ME">Maine</option>
<option value="MD">Maryland</option>
<option value="MA">Massachusetts</option>
<option value="MI">Michigan</option>
<option value="MN">Minnesota</option>
<option value="MS">Mississippi</option>
<option value="MO">Missouri</option>
<option value="MT">Montana</option>
<option value="NE">Nebraska</option>
<option value="NV">Nevada</option>
<option value="NH">New Hampshire</option>
<option value="NJ" selected>New Jersey</option>
<option value="NM">New Mexico</option>
<option value="NY">New York</option>
<option value="NC">North Carolina</option>
<option value="ND">North Dakota</option>
<option value="MP">Northern Mariana Islands</option>
<option value="OH">Ohio</option>
<option value="OK">Oklahoma</option>
<option value="OR">Oregon</option>
<option value="PA">Pennsylvania</option>
<option value="PR">Puerto Rico</option>
<option value="RI">Rhode Island</option>
<option value="SC">South Carolina</option>
<option value="SD">South Dakota</option>
<option value="TN">Tennessee</option>
<option value="TX">Texas</option>
<option value="UT">Utah</option>
<option value="VT">Vermont</option>
<option value="VI">Virgin Islands</option>
<option value="VA">Virginia</option>
<option value="WA">Washington</option>
<option value="WV">West Virginia</option>
<option value="WI">Wisconsin</option>
<option value="WY">Wyoming</option>
</select>

for

<select id="days" onchange="getAndDraw()">
<option value="14">14 days</option>
<option value="21">21 days</option>
<option value="30">30 days</option>
<option value="45" selected>45 days</option>
<option value="60">60 days</option>
<option value="90">90 days</option>
<option value="120">120 days</option>
<option value="9999">all time</option>
</select>
    
Generated at: <span id="datetime"></span>.

<h2>COVID-19 Daily Statistics</h2>
    <div class="cchart" id="deaths_div"></div>
    <div class="cchart" id="results_div"></div>
    <div class="cchart" id="positives_div"></div>
    <div class="cchart" id="negatives_div"></div>
    <!-- <div class="cchart" id="hospitalized_div"></div> -->
<hr>    

<h2>COVID-19 Cumulative To Date Statistics</h2>
    <div class="cchart" id="cumdeath_div"></div>
    <div class="cchart" id="cumresults_div"></div>
    <div class="cchart" id="cumpositives_div"></div>
    <div class="nopad" id="cumnegatives_div"></div>
    <!-- <div class="nopad" id="cumhospitalized_div"></div> -->

    <script>
      var dt = new Date();
      document.getElementById("datetime").innerHTML = dt.toLocaleString();

      window.onresize = drawAll;
    </script>

    <hr>

  </body>
</html>
